var TgChart=function(t){var i={};function e(s){if(i[s])return i[s].exports;var a=i[s]={i:s,l:!1,exports:{}};return t[s].call(a.exports,a,a.exports,e),a.l=!0,a.exports}return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var a in t)e.d(s,a,function(i){return t[i]}.bind(null,a));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t["default"]}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=0)}([function(t,e){class s{roundRect(t,i,e,s,a,h,n){let l=s-i,r=a+1;[[[0,0],[0,r],[i,r],[i,0]],[[s,0],[s,r],[l,r],[l,0]],[[0,0],[s,0],[s,e],[0,e]],[[0,r-e],[0,r],[s,r],[s,r-e]]].forEach(i=>this.line(t,i,n,1,1,!0)),t.beginPath(),t.moveTo(i,a-e),t.arcTo(i,r-e,i+s/2,r-e,h),t.lineTo(i,r-e),t.closePath(),t.fillStyle=n,t.fill(),t.beginPath(),t.moveTo(i,a),t.arcTo(i,e,i+s/2,e,h),t.lineTo(i,e),t.closePath(),t.fillStyle=n,t.fill(),t.beginPath(),t.moveTo(l-s/2,r-e),t.arcTo(l,r-e,l,0,h),t.lineTo(l,r-e),t.closePath(),t.fillStyle=n,t.fill(),t.beginPath(),t.moveTo(l,a),t.arcTo(l,e,s-s/2,e,h),t.lineTo(l,e),t.closePath(),t.fillStyle=n,t.fill()}rotatedDraw(t,i,e,s,a){t.save(),t.beginPath(),t.translate(i,e),t.rotate(s*Math.PI/180),a(),t.restore()}pie(t,i,e,s,a){t.beginPath(),t.moveTo(i.x,i.y),t.arc(i.x,i.y,e,a.start,a.end),t.closePath(),t.fillStyle=s,t.strokeStyle=s,t.fill(),t.stroke()}line(t,i,e,s=1,a=1,h=!1){if(void 0!==i&&i.length){t.beginPath(),t.strokeStyle=this.resolve_color(e,a),t.lineWidth=s,t.moveTo(i[0][0],i[0][1]);for(let e=1;e<i.length;e++)t.lineTo(i[e][0],i[e][1]);h&&(t.fillStyle=t.strokeStyle,t.fill()),t.stroke()}}text(t,i,e,s,a,h=1,n="12px Helvetica"){t.font=n,t.fillStyle=this.resolve_color(a,h),t.fillText(i,e,s)}resolve_color(t,i){const e=parseInt(t.slice(1,t.length),16);return`rgba(${e>>16&255}, ${e>>8&255}, ${255&e}, ${i})`}clear(t,i,e){t.clearRect(0,0,i,e)}}t.exports=class{constructor(t){this.animations=[],this.params=[],this.allowedChartTypes=["line","bar","area","pie"],this.setParams(t),this.loadInputData(this.params.data),this.init_length=Math.ceil(this.x.data.length/6),this.active_to=this.x.data.length,this.active_from=this.active_to-this.init_length,this.has_zoom=!0,this.zoomed=!1,this.one_day=!1,this.main_data=this.params.data,this.global_id=Math.random(),this.main_element=document.getElementById(t.id),this.drawer=new s,this.buildHtml(),this.initMap(),this.initLegends(),this.initPointer(),this.updatePointerRange(),this.anime_params={round_rect:0,axis_alpha:1,vortex:0,rotate:0,bar_alpha:1,active_bar:null,step_scale:1},this.ANIMATION_GLOBAL=1,this.ANIMATION_LINE=0,this.calculateScale(),this.drawMap(),this.drawChart(),this.animation_data={},this.do_anime=!1;let i=null;const e=t=>{if(this.do_anime){i=i||performance.now();for(let e=0;e<this.animations.length;e++){let s=this.animations[e];if(!s)continue;if(s.time_fraction=(t-i)/s.duration,s.time_fraction>1){s.type==this.ANIMATION_GLOBAL?this.anime_params[s.p]=this.animations[e].new_val:this.lines[s.line_id][s.p]=this.animations[e].new_val,"function"==typeof s.cb&&s.cb(),this.animations[e]=null,this.animations.filter(t=>null!=t).length||(i=this.do_anime=!1);continue}let a=(s.new_val-s.old_val)*Math.pow(s.time_fraction,2);this.animations[e].current=s.old_val+a,s.type==this.ANIMATION_GLOBAL?this.anime_params[s.p]=this.animations[e].current:this.lines[s.line_id][s.p]=this.animations[e].current}this.drawChart()}requestAnimationFrame(e)};requestAnimationFrame(e)}calculateScale(){let t=1;if("bar"==this.type)t=(this.axis_height-this.axis_y)/this.findMaxSum(),this.map_scale_y=(this.map_height-this.map_y)/this.findMaxSum(!0),this.lines.map(i=>i.scale_y=t);else if("area"==this.type)this.map_scale_y=1,this.lines.map(i=>i.scale_y=t);else if("line"==this.type)if(this.y_scaled)for(let i of this.lines){if(!i.is_active)continue;let t=0,e=0,s=i.data[this.active_from];for(let a=this.active_from;a<this.active_to;a++)e<i.data[a]&&a>=this.active_from&&a<this.active_to&&(e=i.data[a]),t<i.data[a]&&(t=i.data[a]),s>i.data[a]&&(s=i.data[a]);this.map_scale_y||(this.map_scale_y=new Array),this.map_scale_y.push((this.map_height-this.map_y)/t),i.scale_y=(this.axis_height-this.axis_y)/(e-s)}else{let i=null;for(let t=0;t<this.lines.length;t++)for(let e=this.active_from;e<this.active_to;e++)(i>this.lines[t].data[e]||null===i)&&this.lines[t].is_active&&(i=this.lines[t].data[e]);t=(this.axis_height-this.axis_y)/(this.findMaxValue()-i),this.map_scale_y=(this.map_height-this.map_y)/this.findMaxValue(!0),this.lines.map(i=>i.scale_y=t)}else"pie"==this.type&&(this.map_scale_y=1,this.lines.map(i=>i.scale_y=t))}buildHtml(){const t="tg-chart-"+this.global_id;let i=this.getMapTemplate(),e=this.getPointerTemplate(),s=this.getLegendTemplate();const a=`\n        ${e}\n        <canvas height="${this.height}" width="${this.width}" id="${t}"></canvas>\n        ${i}\n        ${s}\n        `;this.main_element.innerHTML+=a,this.chart=document.getElementById(t),this.chart_ctx=this.chart.getContext("2d")}getLegendTemplate(){this.lenend_id="legend-"+this.global_id;let t="";for(let i=0;i<this.lines.length;i++)t+=`<li name="${i}">\n            <svg height="27" width="27">\n                <circle cx="13" cy="13" r="12" stroke="${this.lines[i].colour}" style="fill:${this.lines[i].colour}"></circle>\n                <path stroke-width="2" fill="none" d="M 7 13 L 12 18 L 19 8"></path>\n            </svg>\n            <div class="legend-title">\n                ${this.lines[i].name}\n            </div>\n            </li>`;return`\n        <div class="legends" id="${this.lenend_id}">\n            <ul>${t}</ul>\n        </div>\n        `}initLegendHandlers(){let t=new Map;this.active_shaker=!1,this.long_click=!1;let i=null;const e=document.getElementById(this.lenend_id).getElementsByTagName("li");[...e].forEach(s=>s.addEventListener("mousedown",a=>{this.active_shaker=!0,i=setTimeout(()=>{if(!this.active_shaker)return;this.active_shaker=!1,this.long_click=!0;const i=s.getAttribute("name");this.uncheckOtherFilters(i),[...e].forEach(i=>{const e=i.getAttribute("name");let s=this.lines[e].is_active?this.lines[e].colour:this.params.bgcolor;i.getElementsByTagName("circle")[0].style.fill=s,t.set(e,!this.lines[e].is_active)})},1200)})),[...e].forEach(t=>t.addEventListener("mouseup",t=>{this.active_shaker=!1,clearTimeout(i)})),[...e].forEach(i=>i.addEventListener("click",()=>{if(this.long_click)return void(this.long_click=!1);const e=i.getAttribute("name");let s=!!t.get(e);if(!this.lines[e])return;if(!s&&[...t].filter(t=>t[1]).length==this.lines.length-1)return i.className="shaked-button",void setTimeout(()=>i.className="",500);let a=s?this.lines[e].colour:this.params.bgcolor;i.getElementsByTagName("circle")[0].style.fill=a,t.set(e,!s),this.animateToggleLine(e)}))}initLegends(){this.initLegendHandlers()}updatePointerRange(t=null){const i=document.getElementById(`pointer-range-${this.global_id}`);let e=this.getRangeDateString(this.x.data[this.active_from]),s=this.getRangeDateString(this.x.data[this.active_to-1]),a=this.one_day?this.getRangeDateString(this.one_day,!0):e+" - "+s;t&&(a=this.getRangeDateString(t,!0)),i.innerText=a}initMapHandlers(){const t=document.getElementById(this.map_ids.window),i=document.getElementById(this.map_ids["window-left"]),e=document.getElementById(this.map_ids["overflow-left"]),s=document.getElementById(this.map_ids["window-right"]),a=document.getElementById(this.map_ids["overflow-right"]);let h=0,n=0,l=0,r=!1,o=!1,d=!1,_=this.width/this.x.data.length;e.style.width=Math.round(_*this.active_from)+"px";let c=Math.round(this.width/8);t.style.minWidth=c+"px",a.style.width="0px";const p=t=>t.touches?t.touches[0].clientX:t.clientX,m=e=>{d=!0,r=!0,o=!0,l=t.offsetWidth,n=i.offsetLeft-p(e),h=a.offsetLeft-p(e)},u=t=>{t.stopPropagation(),t.touches||t.preventDefault(),o=!0,n=i.offsetLeft-p(t)},f=t=>{t.stopPropagation(),t.touches||t.preventDefault(),this.freeze_pointer=!1,r=!0,h=a.offsetLeft-p(t)},v=()=>{(r||o)&&(r=!1,o=!1,d=!1)},y=(t,i)=>{let e=d?l:c,s=d?0:2,a=this.width-e-parseFloat(i)-s;return t=(t=t<0?0:t)>a?a:t},g=i=>{if(i.touches||i.preventDefault(),i.stopPropagation(),r){let t=this.width-p(i)-h;a.style.width=y(t,e.style.width)+"px"}if(o){let t=p(i)+n;e.style.width=y(t,a.style.width)+"px"}if(r||o){let i=Math.floor(t.offsetLeft/this.map_step),e=Math.ceil((t.offsetLeft+t.offsetWidth)/this.map_step);(d&&this.active_from!=i&&this.active_to!=e||!d&&(this.active_from!=i||this.active_to!=e))&&(this.active_from=i,this.active_to=e,this.updatePointerRange(),this.animateMove())}};i.addEventListener("mousedown",u),s.addEventListener("mousedown",f),t.addEventListener("mousedown",m),i.addEventListener("touchstart",u),s.addEventListener("touchstart",f),t.addEventListener("touchstart",m),document.addEventListener("mousemove",g),document.addEventListener("touchmove",g),document.addEventListener("mouseup",v),document.addEventListener("touchend",v),document.addEventListener("touchcancel",v)}getMapTemplate(){return this.map_height=Math.floor(this.height/6),this.map_ids={canvas:"chart-map-"+this.global_id,"overflow-left":"map-overflow-left"+this.global_id,"window-left":"map-window-left"+this.global_id,window:"map-window"+this.global_id,"window-right":"map-window-right"+this.global_id,"overflow-right":"map-overflow-right"+this.global_id},`\n        <div class="map" style="width:${this.width}px; height: ${this.map_height}px;">\n            <div class="map-overflow-left" id="${this.map_ids["overflow-left"]}"></div>\n            <div class="map-window" id="${this.map_ids.window}">\n                <div class="map-window-left" id="${this.map_ids["window-left"]}"></div>\n                <div class="map-window-right" id="${this.map_ids["window-right"]}"></div>\n            </div>\n            <div class="map-overflow-right" id="${this.map_ids["overflow-right"]}"></div>\n        </div>\n        <div>\n            <canvas height="${this.map_height}" width="${this.width}" id="${this.map_ids.canvas}"></canvas>\n        </div>\n        `}initMap(){const t=document.getElementById(this.map_ids.canvas);this.map_ctx=t.getContext("2d"),this.initMapHandlers()}hidePointer(){this.freeze_pointer||(document.getElementById(this.pointer_id).style.display="none",this.is_chart_mouseover=!1,"bar"==this.type&&(this.animations.push({current:this.anime_params.bar_alpha,old_val:this.anime_params.bar_alpha,new_val:1,p:"bar_alpha",duration:300,type:this.ANIMATION_GLOBAL}),this.do_anime=!0,this.anime_params.active_bar=null))}initPointerHandler(){const t=document.getElementById(this.pointer_id),i=t.getElementsByClassName("xpointer-label")[0],e=document.getElementsByClassName("pointer-zoom")[0],s=document.getElementById(`zoom-button-out-${this.global_id}`),a=document.getElementById(`title-${this.global_id}`),h=t.getElementsByClassName("xpointer-label-title")[0],n=t.getElementsByClassName("xpointer-label-values"),l=t.getElementsByClassName("xpointer-label-names"),r=t.getElementsByClassName("xpointer-label-percents");let o="",d="";"line"==this.type&&(o=t.getElementsByClassName("xpointer")[0],d=t.getElementsByClassName("ypointer"));let _=null;this.is_chart_mouseover=!1,this.prev_pie_line=null,this.freeze_pointer=!1;const c=()=>{this.freeze_pointer||(t.style.display="block",this.is_chart_mouseover=!0,e.style.display=this.has_zoom?"block":"none",s.style.display=this.has_zoom&&this.zoomed?"block":"none",a.style.display=this.has_zoom&&this.zoomed?"none":"block","line"==this.type&&[...d].forEach((t,i)=>t.style.display=this.lines[i].is_active?"block":"none"),"pie"==this.type?(h.style.display="none",t.style.display="none"):([...n].forEach((t,i)=>t.style.display=this.lines[i].is_active?"":"none"),[...l].forEach((t,i)=>t.style.display=this.lines[i].is_active?"":"none"),h.style.display="block"),[...r].forEach((t,i)=>t.style.display="none"),"area"==this.type&&[...r].forEach((t,i)=>t.style.display=this.lines[i].is_active?"":"none"))},p=t=>t.touches?t.touches[0].clientX:t.clientX,m=t=>t.touches?t.touches[0].clientY:t.clientY,u=t=>{let i=m(t)-this.main_element.offsetTop+this.axis_y+window.scrollY,e=p(t)-this.main_element.offsetLeft,s=Math.sqrt(Math.pow(e-this.pie_center[0],2)+Math.pow(i-this.pie_center[1],2));if(s<=this.pie_radius){let t=i-this.pie_center[1],a=Math.acos(t/s)+(e<this.pie_center[0]?Math.PI/2:0);e>this.pie_center[0]&&i<this.pie_center[1]&&(a=2*Math.PI+Math.PI/2-a),e>this.pie_center[0]&&i>this.pie_center[1]&&(a=Math.PI/2-a);for(let i=0;i<this.pie_percents.length;i++)if(a>this.pie_percents[i][0].start&&a<this.pie_percents[i][0].end)return i}return null},f=e=>{if(!this.is_chart_mouseover||this.freeze_pointer)return;if(!e.touches){let t=(window.pageYOffset||document.documentElement.scrollTop)+m(e);i.style.top=t+"px"}const s=Math.round(p(e)/this.step)*this.step,a=this.active_from+Math.round(p(e)/this.step);if(_&&s==_&&"line"==this.type)return;if(_=s,!this.x.data[a]&&"pie"!=this.type)return;let c="line"==this.type?_+this.chart.offsetLeft:p(e);if("line"==this.type&&(o.style.left=c+"px"),h.innerText=this.getDateString(this.x.data[a],!0),i.style.left=c+i.offsetWidth+20>this.width?c-i.offsetWidth-20+"px":c+20+"px","pie"==this.type){if(this.pie_line_id=u(e),null===this.prev_pie_line||null!==this.pie_line_id&&this.pie_line_id==this.prev_pie_line||(this.animations.push({current:this.lines[this.prev_pie_line].pie_margin,old_val:this.lines[this.prev_pie_line].pie_margin,new_val:1,p:"pie_margin",duration:200,line_id:this.prev_pie_line}),this.prev_pie_line=null,this.do_anime=!0),null!==this.pie_line_id&&this.pie_line_id!==this.prev_pie_line){let t=this.lines[this.pie_line_id].pie_margin?this.lines[this.pie_line_id].pie_margin:1;this.animations.push({current:t,old_val:t,new_val:this.lines[this.pie_line_id].pie_margin&&1!=this.lines[this.pie_line_id].pie_margin?1:30,p:"pie_margin",duration:200,line_id:this.pie_line_id}),this.prev_pie_line=this.pie_line_id,this.do_anime=!0}if(null!==this.pie_line_id){let i=0;for(let t=this.active_from;t<this.active_to;t++)i+=this.lines[this.pie_line_id].data[t];n[this.pie_line_id].innerText=i,t.style.display="block"}else t.style.display="none";return[...n].forEach((t,i)=>t.style.display=this.pie_line_id==i?"":"none"),void[...l].forEach((t,i)=>t.style.display=this.pie_line_id==i?"":"none")}if("area"==this.type){let t=0;for(let i of this.lines)t+=i.data[a];[...r].forEach((i,e)=>i.innerText=Math.round(100*this.lines[e].data[a]/t)+"%")}"bar"==this.type&&this.anime_params.active_bar!=a&&(this.anime_params.active_bar=a,this.animations.push({current:this.anime_params.bar_alpha,old_val:this.anime_params.bar_alpha,new_val:.5,p:"bar_alpha",duration:100,type:this.ANIMATION_GLOBAL}),this.do_anime=!0);for(let t=0;t<this.lines.length;t++){if("line"==this.type){let i=this.lines[t].data[this.active_from];for(let s=this.active_from;s<this.active_to;s++)i>this.lines[t].data[s]&&(i=this.lines[t].data[s]);const e=this.axis_height+this.axis_y-this.lines[t].scale_y*(this.lines[t].data[a]-i);d[t].style.top=e+this.chart.offsetTop+"px",d[t].style.left=o.style.left}n[t].innerText=this.lines[t].data[a]}},v=t=>{const i=this.active_from+Math.round(p(t)/this.step);this.animateZoom(this.x.data[i])};document.addEventListener("click",()=>{this.freeze_pointer=!1,this.hidePointer()}),this.chart.addEventListener("click",t=>{t.stopPropagation(),!this.freeze_pointer&&this.has_zoom?this.freeze_pointer=!0:this.freeze_pointer=!1}),h.addEventListener("click",v),s.addEventListener("click",v),this.chart.addEventListener("mouseover",c),this.chart.addEventListener("mouseout",()=>this.hidePointer()),i.addEventListener("mouseover",c),i.addEventListener("mouseout",()=>this.hidePointer()),"line"==this.type&&(o.addEventListener("mouseover",c),o.addEventListener("mouseout",()=>this.hidePointer()),[...d].forEach(t=>{t.addEventListener("mouseover",c),t.addEventListener("mouseout",()=>this.hidePointer())})),this.chart.addEventListener("mousemove",f),this.chart.addEventListener("touchmove",f)}getPointerTemplate(){this.pointer_id="pointer-"+this.global_id;let t="",i="";for(let e=0;e<this.lines.length;e++)i+=`<div class="ypointer" style="background-color: ${this.lines[e].colour}"><div class="ypointer-inner"></div></div>`,t+=`<tr>\n            <td class="xpointer-label-percents"></td>\n            <td class="xpointer-label-names">${this.lines[e].name}</td>\n            <td class="xpointer-label-values" style="color: ${this.lines[e].colour}"></td></tr>`;return"line"==this.type&&(i=`<div class="xpointer" style="height: ${this.axis_height+this.axis_y}px"></div>\n            <div class="ypointers">${i}</div>`),`\n            <div style="width:${this.width}px;">\n                <b class="title" id="title-${this.global_id}">${this.params.name}</b>\n                <div class="zoom-button-out"  id="zoom-button-out-${this.global_id}"><img src="zoom-out.png">Zoom Out</div>\n                <b class="pointer-range" id="pointer-range-${this.global_id}"></b>\n            </div>\n            <div class="pointer" id="${this.pointer_id}">\n                <div class="xpointer-label">\n                    <div class="pointer-zoom"> > </div>\n                    <div class="xpointer-label-title"></div>\n                    <table>${t}</table>\n                </div>\n                ${i}\n            </div>\n            `}initPointer(){this.initPointerHandler()}loadInputData(t){this.lines=[],this.type=this.params.type,this.y_scaled=!!t.y_scaled;for(let i of t.columns){let e=i[0],s=i.slice(1,i.length);if("x"==t.types[e])this.x={data:s};else{if(-1===this.allowedChartTypes.indexOf(t.types[e]))throw new Error('Unknown column type "'+t.types[e]+'"');this.lines.push({data:s,name:t.names[e],colour:t.colors[e],is_active:!0,alpha:1,scale_y:1,line_width:this.params.chart_line_width,type:t.types[e]}),this.type=t.types[e]}}}animateMove(){if("line"==this.type){if(this.y_scaled)for(let t=0;t<this.lines.length;t++){if(!this.lines[t].is_active)continue;let i=0,e=this.lines[t].data[this.active_from];for(let a=this.active_from;a<this.active_to;a++)i<this.lines[t].data[a]&&(i=this.lines[t].data[a]),e>this.lines[t].data[a]&&(e=this.lines[t].data[a]);let s=(this.axis_height-this.axis_y)/(i-e);this.animations.push({current:this.lines[t].scale_y,old_val:this.lines[t].scale_y,new_val:s,p:"scale_y",duration:300,line_id:t})}else{let t=null;for(let e=0;e<this.lines.length;e++)for(let i=this.active_from;i<this.active_to;i++)(t>this.lines[e].data[i]||null===t)&&this.lines[e].is_active&&(t=this.lines[e].data[i]);let i=(this.axis_height-this.axis_y)/(this.findMaxValue()-t);for(let e=0;e<this.lines.length;e++)this.animations.push({current:this.lines[e].scale_y,old_val:this.lines[e].scale_y,new_val:i,p:"scale_y",duration:300,line_id:e})}this.do_anime=!0}else if("bar"==this.type){let t=(this.axis_height-this.axis_y)/this.findMaxSum();for(let i=0;i<this.lines.length;i++){let e={current:this.lines[i].scale_y,old_val:this.lines[i].scale_y,new_val:t,p:"scale_y",duration:300,line_id:i};this.animations.push(e)}this.do_anime=!0}else this.drawChart()}animateToggleLine(t){if("line"==this.type){if(this.y_scaled){this.lines[t].is_active=!this.lines[t].is_active;for(let t=0;t<this.lines.length;t++){if(!this.lines[t].is_active)continue;let i=0,e=this.lines[t].data[this.active_from];for(let a=this.active_from;a<this.active_to;a++)i<this.lines[t].data[a]&&(i=this.lines[t].data[a]),e>this.lines[t].data[a]&&(e=this.lines[t].data[a]);let s=(this.axis_height-this.axis_y)/(i-e);this.animations.push({current:this.lines[t].scale_y,old_val:this.lines[t].scale_y,new_val:s,p:"scale_y",duration:300,line_id:t})}}else{let e=this.lines[i].data[this.active_from];for(let t=this.active_from;t<this.active_to;t++)e>this.lines[i].data[t]&&(e=this.lines[i].data[t]);this.lines[t].is_active=!this.lines[t].is_active;let s=(this.axis_height-this.axis_y)/(this.findMaxValue()-e);for(let t=0;t<this.lines.length;t++)this.animations.push({current:this.lines[t].scale_y,old_val:this.lines[t].scale_y,new_val:s,p:"scale_y",duration:300,line_id:t})}this.animations.push({current:this.lines[t].alpha,old_val:this.lines[t].alpha,new_val:Math.round(this.lines[t].alpha)?0:1,p:"alpha",duration:300,line_id:t,cb:()=>{this.lines[t].is_active=!this.lines[t].is_active,this.drawMap()}}),this.lines[t].is_active=!this.lines[t].is_active}else if("bar"==this.type){this.lines[t].is_active=!this.lines[t].is_active;let i=(this.axis_height-this.axis_y)/this.findMaxSum();this.drawMap(),this.lines[t].is_active=!this.lines[t].is_active;for(let e=0;e<this.lines.length;e++){let s=e==t&&0!=this.lines[e].scale_y?0:i,a=null;t==e&&(a=(()=>{})),this.animations.push({current:this.lines[e].scale_y,old_val:this.lines[e].scale_y,new_val:s,p:"scale_y",duration:100,line_id:e,cb:a})}this.lines[t].is_active?setTimeout(()=>this.lines[t].is_active=!1,150):this.lines[t].is_active=!0}else"area"!=this.type&&"pie"!=this.type||(this.animations.push({current:this.lines[t].alpha,old_val:this.lines[t].alpha,new_val:Math.round(this.lines[t].alpha)?0:1,p:"alpha",duration:Math.round(this.lines[t].alpha)?450:100,line_id:t,cb:()=>{this.drawMap()}}),this.animations.push({current:this.lines[t].scale_y,old_val:this.lines[t].scale_y,new_val:Math.round(this.lines[t].scale_y)?0:1,p:"scale_y",duration:300,line_id:t}));this.do_anime=!0}drawMap(){this.drawer.clear(this.map_ctx,this.width,this.map_height),"line"==this.type?(this.drawLines(this.map_ctx,this.map_scale_y,this.map_height+this.map_y,!0),this.map_step=this.width/this.x.data.length):"bar"==this.type?this.map_step=this.drawBars(this.map_ctx,this.map_scale_y,this.map_height+this.map_y,!0):"area"==this.type?this.map_step=this.drawArea(this.map_ctx,this.map_scale_y,this.map_height+this.map_y,!0):"pie"==this.type&&(this.map_step=this.drawArea(this.map_ctx,this.map_scale_y,this.map_height+this.map_y,!0))}drawChart(){if(this.drawer.clear(this.chart_ctx,this.width,this.height),"line"==this.type){if(this.step=this.drawLines(this.chart_ctx,this.scale_y,this.axis_height+this.axis_y,!1,!0,!0),this.y_scaled)for(let t=0;t<this.lines.length;t++){if(!this.lines[t].is_active)continue;let i=0,e=this.lines[t].data[this.active_from];for(let s=this.active_from;s<this.active_to;s++)i<this.lines[t].data[s]&&(i=this.lines[t].data[s]),e>this.lines[t].data[s]&&(e=this.lines[t].data[s])}else{let t=null;for(let i=0;i<this.lines.length;i++)for(let e=this.active_from;e<this.active_to;e++)(t>this.lines[i].data[e]||null===t)&&this.lines[i].is_active&&(t=this.lines[i].data[e]);this.addYAxis(this.findMaxValue(),!0,5,this.params.text_color,t)}this.addXAxis()}else"bar"==this.type?(this.step=this.drawBars(this.chart_ctx,this.scale_y,this.axis_height+this.axis_y),this.addYAxis(this.findMaxSum(),!1),this.addXAxis()):"area"==this.type?(this.step=this.drawArea(this.chart_ctx,this.scale_y,this.axis_height+this.axis_y),this.addYAxis(100,!1),this.addXAxis()):"pie"==this.type&&this.drawPie(this.chart_ctx)}drawPie(t){const i=Math.round(this.width/2),e=Math.round(this.height/2),s=Math.round(Math.min(this.width,this.height)/2.6);this.pie_radius=s;const a=t=>{let i=0;for(let e=this.active_from;e<this.active_to;e++)i+=this.lines[t].data[e]*this.lines[t].scale_y;return i};let h=0;for(let l=0;l<this.lines.length;l++)this.lines[l].is_active&&(h+=a(l)*this.lines[l].scale_y);let n=0;this.pie_percents=[];for(let l=0;l<this.lines.length;l++){let r=a(l)/h,o=n+2*r*Math.PI*this.lines[l].scale_y,d=n+(o-n)/2,_={start:n,end:o},c=this.lines[l].pie_margin?this.lines[l].pie_margin:1,p=i+c*Math.cos(d)/2,m=e+c*Math.sin(d)/2;this.pie_percents[l]=[_],this.pie_center=[p,m],360!==this.anime_params.rotate?this.drawer.rotatedDraw(t,p,m-10,this.anime_params.rotate,()=>{this.drawer.pie(t,{x:0,y:0},s,this.lines[l].colour,_)}):this.drawer.pie(t,{x:p,y:m},s,this.lines[l].colour,_);let u=Math.round(100*r);if(u>0&&!this.anime_params.rotate){const a=10,h=1.5;let n=i+(u<5?1.7:1)*h*s*Math.cos(d)/2-a,r=e+(u<5?1.7:1)*h*s*Math.sin(d)/2,o=u<5?this.lines[l].colour:this.params.bgcolor;this.drawer.text(t,u+"%",n,r,o,1,"18px Helvetica")}n=o}}uncheckOtherFilters(t){if("line"!=this.type&&"bar"!=this.type)return;let i=!0;for(let e=0;e<this.lines.length;e++)if(e!=t&&this.lines[e].is_active){i=!1;break}this.lines.forEach((t,e)=>{this.lines[e].is_active=i,this.lines[e].alpha=i?1:0}),this.lines[t].is_active=!0,this.lines[t].alpha=1,this.calculateScale(),this.drawChart(),this.drawMap()}changeChartType(){"area"==this.type?this.type="pie":"pie"==this.type&&(this.type="area"),this.drawChart()}animateZoom(t){this.zoomed=!this.zoomed;let i=new Date(t);if(this.params.url,i.getFullYear(),i.getMonth(),i.getMonth(),i.getDate(),i.getDate(),"area"==this.type){let t=this.anime_params.round_rect,i={current:t,old_val:t,new_val:Math.round(t)?0:1,p:"round_rect",duration:250,type:this.ANIMATION_GLOBAL};this.animations.push(i);let e=this.anime_params.vortex,s={current:e,old_val:e,new_val:Math.round(e)?0:1,p:"vortex",duration:200,type:this.ANIMATION_GLOBAL,cb:()=>{let t={current:this.anime_params.rotate,old_val:this.anime_params.rotate,new_val:360,p:"rotate",duration:400,type:this.ANIMATION_GLOBAL,cb:()=>this.anime_params.rotate=0};this.changeChartType(),this.animations.push(t)}};this.animations.push(s);let a=this.anime_params.axis_alpha,h={current:a,old_val:a,new_val:Math.round(a)?0:1,p:"axis_alpha",duration:250,type:this.ANIMATION_GLOBAL};this.animations.push(h)}else if("pie"==this.type){let t={current:this.anime_params.rotate,old_val:this.anime_params.rotate,new_val:-360,p:"rotate",duration:200,type:this.ANIMATION_GLOBAL,cb:()=>{this.anime_params.rotate=0,this.changeChartType();let t=this.anime_params.round_rect,i={current:t,old_val:t,new_val:Math.round(t)?0:1,p:"round_rect",duration:400,type:this.ANIMATION_GLOBAL};this.animations.push(i);let e=this.anime_params.vortex,s={current:e,old_val:e,new_val:Math.round(e)?0:1,p:"vortex",duration:400,type:this.ANIMATION_GLOBAL};this.animations.push(s);let a=this.anime_params.axis_alpha,h={current:a,old_val:a,new_val:Math.round(a)?0:1,p:"axis_alpha",duration:600,type:this.ANIMATION_GLOBAL};this.animations.push(h)}};this.animations.push(t)}this.do_anime=!0}drawArea(t,i,e,s=!1){const a=s?0:this.active_from,h=s?this.x.data.length:this.active_to,n=h-a;let l=this.width/(s?this.x.data.length:h-a);const r=[];let o=0;for(let _=a;_<h;_++){let t=0;for(let e=0;e<this.lines.length;e++){if(!Math.round(this.lines[e].alpha))continue;r[e]||(r[e]={i:e,data:[]});let s=i||this.lines[e].scale_y;t+=this.lines[e].data[_]*s,r[e].data.push([o,t])}o+=l}let d=[[0,e],[this.width,e]];for(let _=0;_<r.length;_++){if(!r[_])continue;let i=this.lines[r[_].i];for(let t=0;t<r[_].data.length;t++){let i=1;this.anime_params.vortex&&_!=r.length-1&&0!=_&&_!=r.length-1&&(i=(i=Math.cos(Math.PI*(t/(1.6*n))*this.anime_params.vortex))<0?0:i);let s=r[r.length-1].data[t][1],a=r[_].data[t][1];r[_].data[t][1]=e-a/s*e*i}let s=this.interpolate(r[_].data),a=s.data;a=a.concat(d.reverse()),d=s.data,this.drawer.line(t,a,i.colour,i.line_width,i.alpha,!0)}if(this.anime_params.round_rect>0){let i=Math.round(Math.min(this.width,this.height)/2.6),s=(this.width-2*i)/2*this.anime_params.round_rect,a=(e-2*i)/2*this.anime_params.round_rect;i*=this.anime_params.round_rect,this.drawer.roundRect(t,s,a,this.width,e,i,"#FFFFFF")}return l}drawBars(t,i,e,s=!1){const a=s?0:this.active_from,h=s?this.x.data.length:this.active_to,n=this.anime_params.step_scale*this.width/(h-a);let l=[];for(let r of this.lines){if(!r.is_active)continue;let s=-n/2;for(let o=a;o<h;o++){let a=(i||r.scale_y)*r.data[o],h=l[o]?l[o]:e,d=h-a,_=r.alpha*(this.anime_params.active_bar==o?1:this.anime_params.bar_alpha);this.drawer.line(t,[[s,h],[s,d]],r.colour,n,_),l[o]=d,s+=n}}return n}drawLines(t,i,e,s=!1,a=!0,h=!1){let n=0;for(let l=0;l<this.lines.length;l++){if(!this.lines[l].is_active)continue;let r=i&&i[l]?i[l]:i,o=this.calculateLinePoints(this.lines[l],r,e,s,a,h);this.drawer.line(t,o.data,this.lines[l].colour,this.lines[l].line_width,this.lines[l].alpha),n=o.step}return n}calculateLinePoints(t,i,e,s=!1,a=!0,h=!1){const n=s?t.data:t.data.slice(this.active_from,this.active_to);let l=null;if(h)for(let _=0;_<n.length;_++)(l>n[_]||null===l)&&(l=n[_]);const r=this.width/n.length;let o=[],d=0;for(let _=0;_<n.length;_++){let s=i||t.scale_y;o.push([d,e-s*(n[_]-l)]),d+=r}return a&&o.length>0?this.interpolate(o):{step:r,data:o}}interpolate(t){const i=[];for(let h=0;h<5;h++){const t=h/5;i.push([2*t**3-3*t**2+1,3*t**2-2*t**3,t**3-2*t**2+t,t**3-t**2])}t.unshift(t[0]),t.push(t[t.length-1]);let e=[],s=0,a=this.anime_params.step_scale*this.width/(5*(t.length-3));for(let h=0;h<t.length-3;h++)for(let n=0;n<5;n++){let l=.5*(t[h+2][1]-t[h][1]),r=.5*(t[h+3][1]-t[h+1][1]),o=l*i[n][2]+t[h+1][1]*i[n][0]+t[h+2][1]*i[n][1]+r*i[n][3];e.push([s,o]),s+=a}return e.push([s+a,t[t.length-1][1]]),{step:a=this.anime_params.step_scale*a*5,data:e}}findMaxValue(t=!1){let i=t?0:this.active_from,e=t?this.x.data.length:this.active_to,s=0;for(let a of this.lines.filter(t=>t.is_active))for(let t=i;t<e;t++)s<a.data[t]&&(s=a.data[t]);return s}findMaxSum(t=!1){let i=t?0:this.active_from,e=t?this.x.data.length:this.active_to,s=0,a=[];for(let h=0;h<this.lines.length;h++)if(this.lines[h].is_active)for(let t=i;t<e;t++)a[t]=a[t]?a[t]+this.lines[h].data[t]:this.lines[h].data[t],s<a[t]&&(s=a[t]);return s}addYAxis(t,i=!0,e=5,s=this.params.text_color,a=0){const h=Math.trunc(t-a).toString().length;let n=5*Math.pow(10,h-2),l=Math.ceil((t-a)/n)*n/n;l>7&&(l/=3,n*=3);const r=Math.floor((this.axis_height-this.axis_y)/l),o=t=>t>1e6?Math.round(t/1e6)+"M":t>1e4?Math.round(t/1e3)+"K":t;for(let d=0;d<=l;d++){let t=this.axis_height-d*r+this.axis_y;if(i){let i=0==d?this.params.axis_first_colour:this.params.axis_colour;this.drawer.line(this.chart_ctx,[[0,t],[this.width,t]],i,.5,this.anime_params.axis_alpha)}this.drawer.text(this.chart_ctx,o(n*d+a),e,t-5,s,this.anime_params.axis_alpha)}}addXAxis(){const t=this.active_from,i=this.x.data[this.active_to]?this.active_to:this.active_to-1,e=i-t,s=this.width/e;this.x_step||(this.x_step=Math.round(e/6));const a=e/this.x_step;a>=8&&(this.x_step*=2),a<=4&&(this.x_step/=2);let h=this.x_step;for(let n=this.x.data.length-1;n>=t;n-=h){if(n>i)continue;let e=this.anime_params.axis_alpha,a=s*(n-t)+(n==i?-30:-10),h=this.axis_height+this.axis_y+15;this.drawer.text(this.chart_ctx,this.getDateString(this.x.data[n]),a,h,this.params.text_color,e)}}getDateString(t,i=!1){const e=new Date(t);return(i?["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][e.getDay()]+", ":"")+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+" "+e.getDate()}getRangeDateString(t,i=!1){const e=new Date(t);return(i?["Monday","Tuesday","Wednesday","Thurthday","Friday","Saturday","Sunday"][e.getDay()]+", ":"")+e.getDate()+" "+["January","February","March","April","May","June","July","August","Septembeer","October","November","December"][e.getMonth()]+" "+e.getFullYear()}request(t,i){const e=new XMLHttpRequest;e.open("GET",t),e.onload=function(){if(200==e.status){const t=JSON.parse(this.responseText);i(t)}else console.warn("Request failed. Status "+e.status)},e.send()}setParams(t){const i={type:"line",width:600,height:290,visible_elements_number:35,chart_line_width:2,text_color:"#96A2AA",bgcolor:"#FFFFFF",axis_colour:"#F2F4F5",axis_first_colour:"#ECF0F3"};this.params&&0!=this.params.length||(this.params=i);for(let e in t)this.params[e]=t[e];return this}get height(){return this.params.height}get width(){return this.params.width}get map_y(){return Math.floor(.06*this.map_height)}get axis_y(){return Math.floor(.03*this.height)}get axis_height(){return Math.floor(.9*this.height)}}}]);